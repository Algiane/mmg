/* =============================================================================
**  This file is part of the MMG3D 5 software package for the tetrahedral
**  mesh modification.
**  Copyright (c) 2014 Inria / Universit√© de Bordeaux, IMB / UPMC, LJLL.
**
**  MMG3D 5 is free software: you can redistribute it and/or modify it
**  under the terms of the GNU Lesser General Public License as published
**  by the Free Software Foundation, either version 3 of the License, or
**  (at your option) any later version.
**
**  MMG3D 5 is distributed in the hope that it will be useful, but WITHOUT
**  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
**  FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public
**  License for more details.
**
**  You should have received a copy of the GNU Lesser General Public
**  License and of the GNU General Public License along with MMG3D 5 (in
**  files COPYING.LESSER and COPYING). If not, see
**  <http://www.gnu.org/licenses/>. Please read their terms carefully and
**  use this copy of the MMG3D 5 distribution only if you accept them.
** =============================================================================
*/

/****************************************
 * genheader.c
 *
 * generate an executable to generate
 * headers for Fortran Mmg3d5 users.
 * Used by makefile
 ****************************************/

#include <stdio.h>
#include <errno.h>
#include <string.h>
#include <stdlib.h>

/*
  Program: genheader

  Generate headers (for fortran) setting MMG5_DATA_PTR
  macro to the correct value.

  Parameters:
  argc - must be 3
  argv - contains the names wanted for the Fortran header

  Returns:
  EXIT_SUCCESS

*/
int main (int argc, char ** argv)
{
  char * header_f  = NULL;
  char * libmmg_h  = NULL;
  char * genfort   = NULL;
  char * cmd       = NULL;
  FILE * file      = NULL;

  if (argc != 4)
    {
      fprintf(stderr, "usage : %s headerNameFortran.h libmmg3d5.h"
              " genfort.pl\n",argv[0]);
      return EXIT_FAILURE;
    }

  header_f  = argv[1];
  libmmg_h  = argv[2];
  genfort   = argv[3];

  /* Fortran header */
  file = fopen (header_f,"w");

  if ( file == NULL )
    return(EXIT_FAILURE);

  fprintf(file,"! /** This file is automatically generated by the"
          "\"genheader.c\" code\n");
  fprintf(file,"! * and the \"genfort.pl\" script (../Scripts).\n");
  fprintf(file,"! * Do not modified it by hand, it will be discarded.\n");
  fprintf(file,"! * Note: \"genfort.pl\" is automatically called by the ");
  fprintf(file,"\"genheader.c\"\n! *  executable code.*/\n\n");

  /* Compute the size of the C pointer for the Fortran programm */
  fprintf(file, "#define MMG5_DATA_PTR_T INTEGER(kind=%d)\n",
          (int)sizeof(void*));

  fclose(file);

  /* Generate Fortran header */
  if (NULL == (cmd = (char*)malloc((strlen(genfort)+
                                    strlen(libmmg_h)+
                                    strlen(header_f)+128)*sizeof(char))))
    return EXIT_FAILURE;
  sprintf(cmd, "perl %s -f %s >> %s;",
          genfort, libmmg_h, header_f);
  fprintf(stdout, "%s\n", cmd);
  if (-1 == system(cmd))
    return EXIT_FAILURE;
  free(cmd);

  return(0);
}
